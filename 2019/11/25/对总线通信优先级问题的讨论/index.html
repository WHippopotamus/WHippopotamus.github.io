<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>Hexo</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/font_859455_eaq7v6w8ktj.css">
</head>
<body>
<header class="header">
    <div class="header-inner">
        <div class="header-title">

        </div>
        <nav class="header-nav">
            
            <a href="/" class="header-nav-link" >
                Home
            </a>
            

            
            <a href="/archives" class="header-nav-link">
                Archives
            </a>
            

            
            <a href="/tags" class="header-nav-link">
                Tags
            </a>
            

            
        </nav>
    </div>
</header>
<header class="mobile-header">
    <div class="mobile-nav">
        <div class="mobile-nav-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="mobile-nav-title">
            <a href="/" class="mobile-nav-title-link">John Doe's Blog</a>
        </div>

    </div>
    <nav class="mobile-menu">
        <ul class="mobile-menu-list">
            <li class="mobile-menu-item">
                <i class="iconfont icon-home"></i>
                <a href="/" class="mobile-nav-link">Home</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-archive"></i>
                <a href="/archives" class="mobile-nav-link">Archives</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-tag"></i>
                <a href="/tags" class="mobile-nav-link">Tags</a>
            </li>
            <li class="mobile-menu-item">
                <i class="iconfont icon-about"></i>
                <a href="/about/" class="mobile-nav-link">About</a>
            </li>
        </ul>
    </nav>
</header>
<div class="main">
    <div class="content-inner">
        <div class="posts">
    <article class="post-whole">
        <div class="post-title">
            <h2 class="title">对总线通信优先级问题的讨论</h2>
            <div class="post-meta">
                <span class="post-time">2019-11-25</span>
                
                <span class="post-visit"> visited：<span id="busuanzi_value_page_pv"></span></span>
            </div>
        </div>
        <div class="post-toc" id="post-toc">
    <strong class="post-toc-title">目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#对总线通信中优先级问题的讨论"><span class="toc-text">对总线通信中优先级问题的讨论</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、主要实验目标"><span class="toc-text">一、主要实验目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、系统网络结构"><span class="toc-text">二、系统网络结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-系统网络结构及工作原理"><span class="toc-text">1. 系统网络结构及工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Simulink模型"><span class="toc-text">2. Simulink模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-仿真结果及分析"><span class="toc-text">3. 仿真结果及分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、关键问题及策略总结"><span class="toc-text">三、关键问题及策略总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#“优先级”的含义："><span class="toc-text">“优先级”的含义：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#任务调度策略："><span class="toc-text">任务调度策略：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-text">参考资料</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#附录"><span class="toc-text">附录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#关键代码："><span class="toc-text">关键代码：</span></a></li></ol></li></ol></li></ol>
    <div class="back-to-top" id="back-to-top">
        <a href="javascript:void(0);" target="_blank" rel="noopener">回到顶部</a>
    </div>
</div>
        <div class="post-content">
            <h1 id="对总线通信中优先级问题的讨论"><a href="#对总线通信中优先级问题的讨论" class="headerlink" title="对总线通信中优先级问题的讨论"></a>对总线通信中优先级问题的讨论</h1><hr>
<h2 id="一、主要实验目标"><a href="#一、主要实验目标" class="headerlink" title="一、主要实验目标"></a>一、主要实验目标</h2><ul>
<li><input checked="" disabled="" type="checkbox"> 搭建一个多节点通信的网络，至少包含两个发送节点、一个接收节点</li>
<li><input checked="" disabled="" type="checkbox"> 为不同的任务引入不同的优先级，以验证当消息发送存在冲突时，总线该如何仲裁</li>
<li><input disabled="" type="checkbox"> 讨论不同的任务调度策略总线通信的影响</li>
</ul>
<p><strong>完成度：</strong>60%</p>
<hr>
<h2 id="二、系统网络结构"><a href="#二、系统网络结构" class="headerlink" title="二、系统网络结构"></a>二、系统网络结构</h2><h3 id="1-系统网络结构及工作原理"><a href="#1-系统网络结构及工作原理" class="headerlink" title="1. 系统网络结构及工作原理"></a>1. 系统网络结构及工作原理</h3><p>构建一个总线通信网络，其中包含：两个信号发送节点，一个信号接收节点，一条CAN总线。</p>
<p><img src="C:/Users/Administrator/AppData/Roaming/Typora/typora-user-images/1573377798270.png" alt="1573377798270"></p>
<p>其工作原理如下：</p>
<p>发送节点1、2周期性的定时向总线中发送消息，且遵循CAN总线协议的报文传送规则。</p>
<p>CAN总线协议的报文传送规则：当总线空闲时，连结到总线的所有节点都可以发送消息（多主控制），且先占有总线获得发送消息的资格（CSMA/CR：Carrier Sense Multiple Access / Collosion Avoidance；如果多个节点同时开始发送消息，那么具有最高优先级（最低ID值）的节点获得发送消息的资格，其余消息则进入到消息缓存区依次等待发送。</p>
<h3 id="2-Simulink模型"><a href="#2-Simulink模型" class="headerlink" title="2. Simulink模型"></a>2. Simulink模型</h3><p>在Matlab中利用TrueTime工具箱搭建的网络通信模型如下：</p>
<p><img src="C:/Users/Administrator/AppData/Roaming/Typora/typora-user-images/1573376814384.png" alt="1573376814384"></p>
<h3 id="3-仿真结果及分析"><a href="#3-仿真结果及分析" class="headerlink" title="3. 仿真结果及分析"></a>3. 仿真结果及分析</h3><p>发送节点1与发送节点2以0.5s为周期定时向总线中发送一个消息，且在下一个周期来临后取相反值。为了方便观察，取节点1消息的幅值为$1$，节点2消息的幅值为$2$。如下图所示，其中，前两排分别为两个发送节点的时序图，后两排分别为两个节点向总线中发送的消息的波形。</p>
<p><img src="C:/Users/Administrator/AppData/Roaming/Typora/typora-user-images/1573389815400.png" alt="1573389815400"></p>
<p>调整发送节点1、2的开始时间、执行时间，使两个节点的消息发送周期存在整数倍关系（此处$T_1=0.5s$,$T_2=1s$），以保证在仿真的过程中能够出现消息发送冲突。接收节点采用事件触发的机制，及当检测到总线中有消息在发送的时候才被触发。通过观察总线的调度计划时序图及接收节点的输出结果，可以对CAN总线的报文传送规则进行验证。</p>
<p>设置发送节点1、2中消息的优先级分别为$2、1$。运行仿真，得到仿真结果如下：</p>
<p>1）总线的调度计划时序图</p>
<p><img src="C:/Users/Administrator/AppData/Roaming/Typora/typora-user-images/1573392189337.png" alt="1573392189337"></p>
<p>2）接收节点的输出结果：（第三排为节点3的输出结果）</p>
<p><img src="C:/Users/Administrator/AppData/Roaming/Typora/typora-user-images/1573394345266.png" alt="1573394345266"></p>
<p><strong>结果分析：</strong></p>
<p>从总线的调度计划时序图中可以看出：发送节点2中消息的优先级的确高于节点1。</p>
<p>为方便观察，设置接收节点中$D/A$转换的执行时间为$0.1s$。对从$t=1s$到$t=3s$时间段内的情况进行分析：</p>
<ul>
<li>t=1s时，节点1、2同时向总线中发送数值-1、0.5，总线按照优先级顺序将0.5、-1先后发送给接收节点。</li>
<li>节点3在接收到1、2的消息后，经过0.1s的延迟（D/A转换器的执行时间为0.1s）后，输出的数值0.5（来自节点2），此时t=0.1s；再经过0.1s的延迟后输出的数值为-1（来自节点1），此时t=0.2s。</li>
<li>t=1.5时，节点1向总线中发送数值1，节点3在收到消息后，经过0.1s的延迟输出数值1，此时t=1.6s。</li>
<li>如果没有新的数值需要显示，节点3会一直保持输出当前的数值不变，直到接收到新的消息为止。</li>
<li>t=2s到t=3s时间段的情况类似，只是输出的数值不同而已。</li>
</ul>
<p>可见，仿真结果满足CAN总线的报文传送规则。</p>
<p>值得注意的是：实际情况中，节点发送和接收的消息可能不仅仅是简单的数值，而是一帧一帧的数据。此处为了讨论方便，暂时未涉及到对数据的编码及长度计算。作者在后续的学习过程中将继续深入探讨其详细的工作模式。</p>
<hr>
<h2 id="三、关键问题及策略总结"><a href="#三、关键问题及策略总结" class="headerlink" title="三、关键问题及策略总结"></a>三、关键问题及策略总结</h2><h3 id="“优先级”的含义："><a href="#“优先级”的含义：" class="headerlink" title="“优先级”的含义："></a>“优先级”的含义：</h3><ol>
<li>若节点中同时存在两个以上的任务需要发送时，则需要给不同的任务设定不同的优先级</li>
<li>若网络中同时存在两个以上的节点需要往总线中发送消息，则需要给给个消息都设置一个特定的优先级</li>
</ol>
<h3 id="任务调度策略："><a href="#任务调度策略：" class="headerlink" title="任务调度策略："></a>任务调度策略：</h3><p>RMS：单调速率策略，任务的周期越短，优先级越高。</p>
<p>DMS：截止期单调策略，任务的截止时间越短，优先级越高。当任务的截止时间等于其周期时：RMS=DMS</p>
<hr>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>RMS: <a href="https://baike.baidu.com/item/RMS/7521847" target="_blank" rel="noopener">https://baike.baidu.com/item/RMS/7521847</a> </p>
<p>DMS: <em>N.C.Audeley, etc. HARD REAL-TIME SCHEDULING:THE DEADLINE_MONOTONIC APPROACH</em></p>
<hr>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="关键代码："><a href="#关键代码：" class="headerlink" title="关键代码："></a>关键代码：</h3><p>发送节点1（初始化程序）：</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sender1_init</span><span class="params">(Amp)</span></span></span><br><span class="line"></span><br><span class="line">ttInitKernel(<span class="string">'prioFP'</span>)</span><br><span class="line"></span><br><span class="line">data.u=Amp;</span><br><span class="line">data.exectime=<span class="number">0</span>;</span><br><span class="line">starttime=<span class="number">0</span>;</span><br><span class="line">period=<span class="number">0.5</span>;</span><br><span class="line"></span><br><span class="line">ttCreatePeriodicTask(<span class="string">'sender1_task'</span>,starttime,period,<span class="string">'sender1_code'</span>,data)</span><br></pre></td></tr></table></figure>

<p>发送节点1（控制代码）：</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[exectime,data]</span> = <span class="title">sender1_code</span><span class="params">(segment, data)</span></span></span><br><span class="line"><span class="keyword">switch</span> segment</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span></span><br><span class="line">        data.u=-data.u;</span><br><span class="line">        exectime = data.exectime;</span><br><span class="line">        ttSendMsg([<span class="number">1</span> <span class="number">3</span>],data.u,<span class="number">10</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span></span><br><span class="line">        ttAnalogOut(<span class="number">1</span>, data.u);</span><br><span class="line">        exectime = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>发送节点2（初始化）：</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sender2_init</span><span class="params">(Amp)</span></span></span><br><span class="line"></span><br><span class="line">ttInitKernel(<span class="string">'prioFP'</span>)</span><br><span class="line"></span><br><span class="line">data.u=Amp;</span><br><span class="line">data.exectime=<span class="number">0</span>;</span><br><span class="line">starttime=<span class="number">0</span>;</span><br><span class="line">period=<span class="number">0.5</span>;</span><br><span class="line"></span><br><span class="line">ttCreatePeriodicTask(<span class="string">'sender2_task'</span>,starttime,period,<span class="string">'sender2_code'</span>,data)</span><br></pre></td></tr></table></figure>

<p>发送节点2（控制代码）：</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[exectime,data]</span> = <span class="title">sender2_code</span><span class="params">(segment, data)</span></span></span><br><span class="line"><span class="keyword">switch</span> segment</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span></span><br><span class="line">        data.u=-data.u;</span><br><span class="line">        exectime = data.exectime;</span><br><span class="line">        ttSendMsg([<span class="number">1</span> <span class="number">3</span>],data.u,<span class="number">10</span>,<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span></span><br><span class="line">        ttAnalogOut(<span class="number">1</span>, data.u);</span><br><span class="line">        exectime = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>接收节点（初始化）：</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">receiver_init</span></span></span><br><span class="line"></span><br><span class="line">ttInitKernel(<span class="string">'prioFP'</span>)</span><br><span class="line"></span><br><span class="line">data.exectime=<span class="number">0.1</span>;</span><br><span class="line">starttime=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">ttCreateTask(<span class="string">'receiver_task'</span>,starttime,<span class="string">'receiver_code'</span>,data)</span><br><span class="line">ttAttachNetworkHandler(<span class="number">1</span>,<span class="string">'receiver_task'</span>)</span><br></pre></td></tr></table></figure>

<p>接收节点（控制代码）：</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="params">[exectime,data]</span> = <span class="title">receiver_code</span><span class="params">(segment, data)</span></span></span><br><span class="line"><span class="keyword">persistent</span> u</span><br><span class="line"><span class="keyword">switch</span> segment</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span></span><br><span class="line">        u=ttGetMsg;</span><br><span class="line">        exectime = data.exectime;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> ~<span class="built_in">isempty</span>(u)</span><br><span class="line">            ttAnalogOut(<span class="number">1</span>, u)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">disp</span>(<span class="string">'Error: actuator received empty message!'</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        exectime = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>


        </div>
        
    </article>
</div>
<div class="paginator">
    
        
        
            <a class="next" href="/2019/11/25/%E5%8D%9A%E5%AE%A2%E5%B0%8F%E7%99%BD/">
                <span class="nav-default">博客小白</span>
                <span class="nav-mobile">Next</span>
                <i class="iconfont icon-next"></i>
            </a>
        
    
</div>
<div id="comment-container"></div>
    </div>
</div>
<footer class="footer-social">
    

    

    

    <div class="footer-copyright">
        <p class="time-line">
            &copy;
            
            
            2019
            &nbsp;<i class="iconfont icon-heart"></i>&nbsp;
            <a target="_blank" href="https://github.com/iJinxin">John Doe</a>
        </p>
        <p class="theme-info">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>  |  Theme -
            <a target="_blank" href="https://github.com/iJinxin/hexo-theme-sky">Sky</a>
        </p>
    </div>
</footer>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
    

</script>
</html>
